<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Simulateur & RÃ©servation â€¢ Transport Confort</title>

  <!-- Fonts + site CSS -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/assets/style.css">

  <!-- App + simulateur (calculs, Google Maps, etc.) -->
  <script src="/js/app.js"></script>
  <script src="/js/simulator.js" defer></script>

  <!-- Calendly (nÃ©cessaire pour l'embed inline) -->
  <link rel="stylesheet" href="https://assets.calendly.com/assets/external/widget.css"/>
  <script src="https://assets.calendly.com/assets/external/widget.js" async></script>

  <style>
    /* Grille locale pour cette page (Ã©vite de toucher Ã  tout le site) */
    .sim-grid {
      display: grid;
      grid-template-columns: 1fr 420px; /* formulaire Ã  gauche, carte Ã  droite */
      gap: 16px;
    }
    @media (max-width: 960px) {
      .sim-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <div class="brand">
        <img src="/assets/logo.png" alt="Logo">
        <div>
          <h1>Transport Confort</h1>
          <div class="slogan">Transport haut de gamme â€¢ Confort premium</div>
        </div>
      </div>
      <nav class="nav">
        <a href="/">Accueil</a>
        <a href="/simulator.html">Simulateur</a>
        <a href="/tarifs.html">Tarifs</a>
        <a href="/mentions.html">Mentions & CGV</a>
        <a href="/a-propos.html">Ã€ propos</a>
        <a href="/cgu.html">CGU</a>
        <a href="/cgv.html">CGV</a>
      </nav>
    </div>

    <!-- ===== SIMULATEUR + CARTE ===== -->
    <div class="sim-grid section">
      <!-- Colonne gauche : formulaire -->
      <div class="card">
        <h2>Demande de trajet</h2>

        <div class="mode" style="margin:6px 0 10px 0;display:flex;gap:10px;align-items:center">
          <label><input type="radio" name="mode" id="mode-course" value="course" checked> Course classique</label>
          <label><input type="radio" name="mode" id="mode-mad" value="mad"> Mise Ã  disposition (MAD)</label>
        </div>

        <div class="badge" style="margin:6px 0">ðŸŽ‰ Offre de lancement : <b>-15% jusquâ€™au 31/12/2025</b></div>

        <label>DÃ©part</label>
        <input id="from" class="input" placeholder="Adresse de dÃ©part" autocomplete="off">

        <label>ArrivÃ©e</label>
        <input id="to" class="input" placeholder="Adresse dâ€™arrivÃ©e" autocomplete="off">

        <!-- DurÃ©e MAD (un SEUL bloc, pas de doublon d'ID !) -->
        <div id="mad-row" class="row" style="display:none; gap:8px; align-items:center; margin:8px 0 0;">
          <label for="mad-hours" style="min-width:140px;">DurÃ©e (MAD)</label>
          <select id="mad-hours" class="input">
            <option value="1">1 h</option>
            <option value="2">2 h</option>
            <option value="3">3 h</option>
            <option value="4">4 h</option>
            <option value="8">8 h (journÃ©e)</option>
          </select>
        </div>

        <div class="row">
          <div>
            <label>Date</label>
            <div style="display:flex;gap:6px">
              <input id="date" class="input" type="date" required>
              <button type="button" id="openDate" class="btn" style="padding:8px 10px">ðŸ“…</button>
            </div>
          </div>
          <div>
            <label>Heure</label>
            <select id="time" class="input"></select>
          </div>
        </div>

        <div class="row">
          <div>
            <label>Passagers</label>
            <select id="pax" class="input"><option>1</option><option>2</option><option>3</option><option>4</option></select>
          </div>
          <div>
            <label>Commentaires</label>
            <input id="note" class="input" placeholder="Infos vol, bagages, siÃ¨ge enfantâ€¦ (optionnel)">
          </div>
        </div>

        <div class="actions" style="margin-top:12px">
          <button id="estimate" class="btn">Estimer</button>
          <button id="calendly" class="btn secondary" disabled>RÃ©server</button>
        </div>
      </div>

      <!-- Colonne droite : carte + indicateurs -->
      <div class="card">
        <div id="map" style="height:360px;border-radius:10px;overflow:hidden;margin-bottom:10px"></div>
        <div class="kpi"><span class="badge">Distance</span> <span id="distance" class="value">â€”</span></div>
        <div class="kpi"><span class="badge">DurÃ©e</span> <span id="duration" class="value">â€”</span></div>
        <div class="price" style="margin:8px 0">
          <span>Total estimÃ© :</span>
          <span id="total" class="value">â€”</span>
          <span id="totalLabel" class="badge" style="margin-left:6px;display:none"></span>
          <span>TTC</span>
        </div>
      </div>
    </div>

    <!-- ===== Calendly inline (sous la grille) ===== -->
    <div class="section">
      <h3>RÃ©servation</h3>
      <p class="small">
        AprÃ¨s lâ€™estimation, cliquez sur <b>RÃ©server</b> pour choisir un crÃ©neau. Vous serez redirigÃ© vers la page de paiement sÃ©curisÃ©.
      </p>
      <div id="calendly-inline"
           class="calendly-inline-widget"
           style="width:100%;height:800px;border:1px solid #222;border-radius:12px"></div>
    </div>

    <!-- Hero + footer -->
    <div class="hero"><img src="/assets/hero-g6.png" alt="XPENG G6"></div>
    <div class="footer small">
      Â© Transport Confort by Vincent â€” SIREN 990 407 397 â€” TVA FR71 990 407 397 â€” 23 rue La BruyÃ¨re, 93800 Ã‰pinay-sur-Seine â€” 07 49 55 62 77
    </div>
  </div>

  <!-- ===== JS pour lâ€™ouverture Calendly ===== -->
  <script>
    // URLs Calendly + IDs de questions (Ã  remplacer quand tu auras crÃ©Ã© les questions)
    const CAL = {
      mad: {
        url: 'https://calendly.com/contact-transportconfort/reservation-chauffeur-prive-mad',
        qid: { date:'QID_MAD_DATE', time:'QID_MAD_TIME', from:'QID_MAD_FROM', duration:'QID_MAD_DURATION', price:'QID_MAD_PRICE' }
      },
      course: {
        url: 'https://calendly.com/contact-transportconfort/reservation-vtc',
        qid: { date:'QID_VTC_DATE', time:'QID_VTC_TIME', from:'QID_VTC_FROM', to:'QID_VTC_TO', price:'QID_VTC_PRICE' }
      }
    };

    function getVal(id){ const el=document.getElementById(id); return el?el.value.trim():''; }

    function waitForCalendly(maxMs = 10000) {
  return new Promise((resolve, reject) => {
    if (window.Calendly) return resolve();
    const t0 = Date.now();
    const timer = setInterval(() => {
      if (window.Calendly) {
        clearInterval(timer);
        resolve();
      } else if (Date.now() - t0 > maxMs) {
        clearInterval(timer);
        reject(new Error('Calendly not loaded'));
      }
    }, 100);
  });
}

    async function openInlineCalendly() {
      try {
        await waitForCalendly(); // sâ€™assurer que Calendly est prÃªt
        // EmpÃªche dâ€™ouvrir sans estimation fiable
        if (!window._TC_LAST || window._TC_LAST.price_eur == null || !window._TC_LAST.from) {
          alert("Faites dâ€™abord une estimation (tarif + adresses).");
          return;
        }

        // 1) donnÃ©es depuis le formulaire / derniÃ¨re estimation
        const isMAD   = !!document.getElementById('mode-mad')?.checked;
        const dateStr = getVal('date');
        const timeStr = getVal('time');
        let whenISO   = (window._TC_LAST && window._TC_LAST.whenISO) || null;
        if (!whenISO && dateStr && timeStr) whenISO = `${dateStr}T${timeStr}:00`;

        const from      = (window._TC_LAST?.from) || getVal('from');
        const to        = isMAD ? '' : ((window._TC_LAST?.to) || getVal('to'));
        const price_eur = (window._TC_LAST?.price_eur ?? null);
        const mad_hours = isMAD ? (window._TC_LAST?.mad_hours || Number(document.getElementById('mad-hours')?.value||1)) : undefined;

        if (!dateStr && !whenISO) { alert('Choisissez une date (ou faites une estimation).'); return; }

        // 2) paquet canon
        const canon = { type: isMAD ? 'mad' : 'course', whenISO, from, to, price_eur, mad_hours };

        // 3) signature serveur (Netlify function) + fallback si 4xx/5xx
        let signed;
        try {
          const r = await fetch('/.netlify/functions/sim-presign', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ canon })
          });

          const canonB64Fallback = btoa(unescape(encodeURIComponent(JSON.stringify(canon))));
          if (!r.ok) {
            console.warn('presign HTTP ' + r.status + ' â€” fallback');
            signed = { signature: '', nonce: '', canon_b64: canonB64Fallback };
          } else {
            signed = await r.json(); // { signature, canon_b64, nonce }
          }
        } catch (e) {
          console.warn('presign error â€” fallback', e);
          const canonB64 = btoa(unescape(encodeURIComponent(JSON.stringify(canon))));
          signed = { signature: '', nonce: '', canon_b64: canonB64 };
        }

        // 4) prefill questions
        const cfg = isMAD ? CAL.mad : CAL.course;
        const ca = {};
        if (cfg.qid.price && price_eur!=null) ca[cfg.qid.price] = (typeof TC!=='undefined' && TC.fmtMoney)? TC.fmtMoney(price_eur) : `${price_eur} â‚¬`;
        if (cfg.qid.from  && from)            ca[cfg.qid.from]  = from;
        if (!isMAD && cfg.qid.to && to)       ca[cfg.qid.to]    = to;
        if (isMAD && cfg.qid.duration && mad_hours) ca[cfg.qid.duration] = `${mad_hours} h`;
        if (cfg.qid.date && whenISO) ca[cfg.qid.date] = whenISO.slice(0,10);
        if (cfg.qid.time && whenISO) ca[cfg.qid.time] = new Date(whenISO).toTimeString().slice(0,5);

        // 5) UTM scellÃ©es (preuve)
        const utm = {
          utm_source: 'simulator',
          utm_medium: signed.signature,     // HMAC (peut Ãªtre vide en fallback)
          utm_term:   signed.nonce,         // anti-rejeu
          utm_content: signed.canon_b64,    // canon encodÃ© base64
          utm_campaign: (window._TC_LAST?.label || (isMAD?'MAD':'COURSE'))
        };

        // 6) URL Calendly avec tes couleurs
        const base = new URL(cfg.url);
        base.searchParams.set('background_color','0B0B0B');
        base.searchParams.set('text_color','FFFFFF');
        base.searchParams.set('primary_color','C7A24B');
        // on place aussi les UTM en query (double ce que lâ€™API fait cÃ´tÃ© widget)
        base.searchParams.set('utm_source', utm.utm_source);
        base.searchParams.set('utm_medium', utm.utm_medium || 'nosig');
        base.searchParams.set('utm_term', utm.utm_term || '');
        base.searchParams.set('utm_content', utm.utm_content || '');
        base.searchParams.set('utm_campaign', utm.utm_campaign || '');

        // 7) lance le widget Calendly inline
        const host = document.getElementById('calendly-inline');
        if (!host) { alert('Zone calendrier manquante (#calendly-inline).'); return; }
        host.innerHTML = ''; // reset

        Calendly.initInlineWidget({
          url: base.toString(),
          parentElement: host,
          prefill: { date: (whenISO ? whenISO.slice(0,10) : undefined), customAnswers: ca },
          utm
        });

           host.scrollIntoView({ behavior:'smooth', block:'start' });
  } catch (e) {
    console.error(e);
    alert("Impossible dâ€™ouvrir le calendrier.");
  }
} // <-- bien fermer openInlineCalendly() avec uniquement une accolade
// ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

/* Accroche du bouton â€œRÃ©serverâ€ et export global */
document.addEventListener('DOMContentLoaded', () => {
  const btn = document.getElementById('calendly');
  if (btn) btn.addEventListener('click', openInlineCalendly);
  // permet Ã  simulator.js d'appeler openInlineCalendly() si besoin
  window.openInlineCalendly = openInlineCalendly;
});


<!doctype html>   
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>Simulateur & R√©servation ‚Ä¢ Transport Confort</title>

  <!-- Feuille globale -->
  <link rel="stylesheet" href="/assets/style.css">

  <!-- App + simulateur (calculs, Google Maps, etc.) -->
  <script src="/js/app.js" defer></script>
  <script src="/js/simulator.js" defer></script>

  <!-- Calendly (embed inline) -->
  <link rel="stylesheet" href="https://assets.calendly.com/assets/external/widget.css">
  <script src="https://assets.calendly.com/assets/external/widget.js" async></script>

  <style>
    /* ===== Th√®me harmonis√© (mobile-first) ===== */
    :root{ --bg:#0B0B0B; --fg:#F5F5F5; --muted:#CFCFCF; --gold:#C7A24B; --line:#1F1F1F; --card:#111111 }
    html,body{background:var(--bg);color:var(--fg);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;line-height:1.55}
    .container{max-width:1120px;margin:0 auto;padding:0 16px}
    /* Scroll fluide pour les ancres (#itineraire, etc.) */
    html{ scroll-behavior:smooth; }

    /* ===== Masthead harmonis√© ===== */
    .masthead{padding:12px 0;border-bottom:1px solid var(--line);background:var(--bg)}
    .brand-block{display:grid;grid-template-columns:auto 1fr;gap:10px;align-items:center}
    .brand-logo{height:56px;width:auto;border-radius:8px;box-shadow:0 4px 14px rgba(0,0,0,.35)}
    .slogan{color:var(--muted);font-size:clamp(13px,3.6vw,15px);line-height:1.35}
    .nav-scroller{
      margin-top:10px;display:flex;gap:16px;white-space:nowrap;overflow-x:auto;overscroll-behavior-x:contain;
      padding-bottom:6px;scrollbar-width:none;border-top:1px solid var(--line);padding-top:10px
    }
    .nav-scroller::-webkit-scrollbar{display:none}
    .nav-scroller a{color:var(--fg);text-decoration:none;font-size:15px;opacity:.92}
    .nav-scroller a[aria-current="page"]{color:var(--gold);font-weight:600;opacity:1}
    @media (min-width:960px){ .brand-logo{height:64px} .nav-scroller{gap:20px} }

    /* ===== UI g√©n√©rique ===== */
    .section{margin:16px 0}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px;box-shadow:0 10px 24px rgba(0,0,0,.25)}
    h2{color:var(--gold);font-size:clamp(20px,5vw,26px);margin:.2rem 0 .6rem}
    h3{color:var(--gold);font-size:clamp(16px,4.2vw,18px);margin:.2rem 0 .5rem}
    .badge{display:inline-block;padding:.3rem .6rem;border:1px solid var(--line);border-radius:999px;color:var(--muted);font-size:.85rem}
    .btn{display:inline-block;padding:10px 14px;border-radius:12px;font-weight:700;text-decoration:none;border:none;cursor:pointer;background:var(--gold);color:#0B0B0B;box-shadow:0 6px 18px rgba(0,0,0,.25)}
    .btn.secondary{background:transparent;color:var(--gold);border:1px solid var(--gold)}
    .row{display:grid;gap:8px}
    .grid{display:grid;gap:16px}
    .kpi{display:flex;align-items:center;gap:8px;margin:6px 0}
    .value{font-variant-numeric:tabular-nums;font-weight:700}

    /* Inputs */
    label{display:block;margin:8px 0 6px;color:#fff;font-weight:600;font-size:.95rem}
    .input, select.input, textarea.input{
      width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:#0f0f0f;color:#fff;
      outline:none;transition:border-color .2s ease, box-shadow .2s ease
    }
    .input:focus{border-color:var(--gold);box-shadow:0 0 0 3px rgba(199,162,75,.15)}
    textarea.input{min-height:84px;resize:vertical}

    /* ===== Grille locale simulateur ===== */
    .sim-grid{display:grid;grid-template-columns:1fr 420px;gap:16px}
    @media (max-width:1000px){ .sim-grid{grid-template-columns:1fr} }

    /* Bloc prix */
    .price{display:flex;align-items:center;gap:8px;font-size:1.05rem}
    .price .value{font-size:1.1rem}

    /* ===== Calendly ‚Äì conteneur + override internes ===== */
    #calendly-inline{
      width:100%;
      height:82vh;
      min-height:900px;
      border:1px solid var(--line);
      border-radius:12px;
      overflow:hidden;
      background:#0b0b0b;
    }
    #calendly-inline .calendly-inline-widget,
    #calendly-inline .calendly-inline-widget iframe{
      height:100% !important;
      min-height:100% !important;
    }
    @media (max-width:480px){
      #calendly-inline{ height:1100px; min-height:1100px; }
    }

    /* Footer */
    .footer{color:var(--muted);margin:14px 0}
  </style>
</head>

<body>
  <div class="container">
    <!-- ===== Header harmonis√© ===== -->
    <header class="masthead" role="banner">
      <div class="brand-block">
        <img class="brand-logo" src="/assets/logo.png" alt="Transport Confort">
        <div class="brand-text">
          <div class="slogan">Transport haut de gamme ‚Ä¢ Confort premium</div>
        </div>
      </div>
      <nav class="nav-scroller" role="navigation" aria-label="Navigation principale">
        <a href="/">Accueil</a>
        <a href="/simulator.html" aria-current="page">Simulateur</a>
        <a href="/tarifs.html">Tarifs</a>
        <a href="/a-propos.html">√Ä propos</a>
        <a href="/mentions.html">Mentions l√©gales</a>
      </nav>
    </header>

    <!-- ===== SIMULATEUR + CARTE ===== -->
    <div class="sim-grid section" aria-label="Simulateur et carte">
      <!-- Colonne gauche : formulaire -->
      <section class="card" aria-labelledby="form-title">
        <h2 id="form-title">Demande de trajet</h2>

        <div class="mode" style="margin:6px 0 10px;display:flex;gap:12px;align-items:center;flex-wrap:wrap">
          <label style="display:flex;gap:8px;align-items:center">
            <input type="radio" name="mode" id="mode-course" value="course" checked> <span>Course classique</span>
          </label>
          <label style="display:flex;gap:8px;align-items:center">
            <input type="radio" name="mode" id="mode-mad" value="mad"> <span>Mise √† disposition (MAD)</span>
          </label>
          <span class="badge">üéÅ ‚Äì15% jusqu‚Äôau 31/12/2025 (appliqu√© sur facture)</span>
        </div>

        <label for="from">D√©part</label>
        <input id="from" class="input" placeholder="Adresse de d√©part" autocomplete="off">

        <label for="to">Arriv√©e</label>
        <input id="to" class="input" placeholder="Adresse d‚Äôarriv√©e" autocomplete="off">

        <!-- Dur√©e MAD -->
        <div id="mad-row" class="row" style="display:none;grid-template-columns:160px 1fr;align-items:center">
          <label for="mad-hours" style="margin:0">Dur√©e (MAD)</label>
          <select id="mad-hours" class="input">
            <option value="1">1 h</option>
            <option value="2">2 h</option>
            <option value="3">3 h</option>
            <option value="4">4 h</option>
            <option value="8">8 h (journ√©e)</option>
          </select>
        </div>

        <div class="row" style="grid-template-columns:1fr 1fr">
          <div>
            <label for="date">Date</label>
            <div style="display:flex;gap:6px">
              <input id="date" class="input" type="date" required>
              <button type="button" id="openDate" class="btn" style="padding:8px 10px">üìÖ</button>
            </div>
          </div>
          <div>
            <label for="time">Heure</label>
            <select id="time" class="input"></select>
          </div>
        </div>

        <div class="row" style="grid-template-columns:1fr 1fr">
          <div>
            <label for="pax">Passagers</label>
            <select id="pax" class="input"><option>1</option><option>2</option><option>3</option><option>4</option></select>
          </div>
          <div>
            <label for="note">Commentaires</label>
            <textarea id="note" class="input" rows="3" placeholder="Infos vol, bagages, demandes sp√©cifiques (optionnel)"></textarea>
          </div>
        </div>

        <div class="row" style="margin-top:12px">
          <div style="display:flex;gap:12px;flex-wrap:wrap">
            <button id="estimate" class="btn">Estimer</button>
            <button id="calendly" class="btn secondary" disabled>R√©server</button>
          </div>

          <label style="display:flex;gap:8px;align-items:center;margin-top:8px">
            <input id="payfull" type="checkbox">
            <span>Payer <b>100%</b> maintenant (ou 20% d‚Äôacompte)</span>
          </label>

          <p style="font-size:.9rem;color:var(--muted);margin:.5rem 0 0">
            ‚ö†Ô∏è La r√©servation n‚Äôest confirm√©e qu‚Äôapr√®s paiement de <strong>l‚Äôacompte de 20%</strong> via Stripe.
            Tout cr√©neau Calendly sans r√®glement pourra √™tre <strong>annul√© d‚Äôoffice</strong>.<br>
            Politique d‚Äôannulation : <strong>remboursement 100% si ‚â• 24h</strong>, sinon acompte conserv√©.
          </p>
        </div>
      </section>

      <!-- Colonne droite : carte + indicateurs -->
      <aside id="itineraire" class="card" aria-labelledby="map-title">
        <h3 id="map-title" style="margin-top:0">Votre itin√©raire</h3>
        <div id="map" style="height:360px;border-radius:10px;overflow:hidden;margin-bottom:10px;background:#0f0f0f"></div>
        <div class="kpi"><span class="badge">Distance</span> <span id="distance" class="value">‚Äî</span></div>
        <div class="kpi"><span class="badge">Dur√©e</span> <span id="duration" class="value">‚Äî</span></div>
        <div class="price" style="margin:8px 0">
          <span>Total estim√© :</span>
          <span id="total" class="value">‚Äî</span>
          <span id="totalLabel" class="badge" style="margin-left:6px;display:none"></span>
          <span>TTC</span>
        </div>
      </aside>
    </div>

    <!-- ===== Calendly inline ===== -->
    <section class="section" aria-labelledby="res-title">
      <h3 id="res-title">R√©servation</h3>
      <p class="badge" style="display:inline-block;margin:0 0 10px">Apr√®s l‚Äôestimation, cliquez sur <b>R√©server</b> pour choisir un cr√©neau et payer en ligne.</p>
      <div id="calendly-inline"></div>
    </section>

    <!-- ===== Footer ===== -->
    <div class="footer small">
      ¬© Transport Confort by Vincent ‚Äî SIREN 990 407 397 ‚Äî TVA FR71 990 407 397 ‚Äî
      23 rue La Bruy√®re, 93800 √âpinay-sur-Seine ‚Äî 07 49 55 62 77
    </div>
  </div>

  <!-- ===== JS d‚Äôint√©gration Calendly (harmonis√© + plein √©cran + formats FR + passagers/commentaires) ===== -->
  <script>
    // === Config URLs + IDs de questions (par ordre dans Calendly) ===
    const CAL = {
      mad: {
        url: 'https://calendly.com/contact-transportconfort/reservation-chauffeur-prive-mad',
        // 1: Date, 2: Heure, 3: Adresse prise en charge, 4: Dur√©e MAD, 5: Tarif, 6: Passagers, 7: Commentaires
        qid: { date:'a1', time:'a2', from:'a3', duration:'a4', price:'a5', pax:'a6', note:'a7' }
      },
      course: {
        url: 'https://calendly.com/contact-transportconfort/reservation-vtc',
        // 1: Date, 2: Heure, 3: Adresse prise en charge, 4: Adresse de d√©pose, 5: Tarif, 6: Passagers, 7: Commentaires
        qid: { date:'a1', time:'a2', from:'a3', to:'a4', price:'a5', pax:'a6', note:'a7' }
      }
    };

    // Helpers
    function getVal(id){ const el=document.getElementById(id); return el ? (el.value||'').trim() : ''; }
    function waitForCalendly(maxMs=15000){
      return new Promise((resolve,reject)=>{
        if (window.Calendly) return resolve();
        const t0=Date.now(), iv=setInterval(()=>{
          if (window.Calendly){ clearInterval(iv); resolve(); }
          else if (Date.now()-t0>maxMs){ clearInterval(iv); reject(new Error('Calendly not loaded')); }
        },100);
      });
    }
    // >>> formatage FR pour champs texte Calendly
    function toFRDate(isoOrYmd){
      if (!isoOrYmd) return '';
      const ymd = isoOrYmd.slice(0,10);               // 'YYYY-MM-DD'
      const [y,m,d] = ymd.split('-');
      if (y && m && d) return `${d}/${m}/${y}`;       // 'DD/MM/YYYY'
      try { return new Date(isoOrYmd).toLocaleDateString('fr-FR'); }
      catch(_) { return isoOrYmd; }
    }
    function toFRTime(hhmm){
      if (!hhmm) return '';
      const m = String(hhmm).match(/^(\d{1,2})[:hH]?(\d{2})$/);
      if (!m) return hhmm;
      const h = m[1].padStart(2,'0');
      const mi = m[2];
      return `${h}h${mi}`;                             // '18h55'
    }

    async function openInlineCalendly(){
      try{
        await waitForCalendly();

        if (!window._TC_LAST || window._TC_LAST.price_eur == null || !window._TC_LAST.from) {
          alert('Faites d‚Äôabord une estimation (tarif + adresses).');
          return;
        }

        const isMAD   = !!document.getElementById('mode-mad')?.checked;
        const dateStr = getVal('date');                // 'YYYY-MM-DD'
        const timeStr = getVal('time');                // 'HH:MM'

        let whenISO = window._TC_LAST?.whenISO || null;
        if (!whenISO && dateStr && timeStr) whenISO = `${dateStr}T${timeStr}:00`;

        const from      = window._TC_LAST?.from || getVal('from');
        const to        = isMAD ? '' : (window._TC_LAST?.to || getVal('to'));
        const price_eur = window._TC_LAST?.price_eur ?? null;
        const mad_hours = isMAD ? (window._TC_LAST?.mad_hours || Number(document.getElementById('mad-hours')?.value || 1)) : undefined;
        const payFull   = !!document.getElementById('payfull')?.checked;

        // NEW: passagers & commentaires
        const paxStr  = (document.getElementById('pax')?.value || '').trim();
        const noteStr = (document.getElementById('note')?.value || '').replace(/\s+\n/g,'\n').trim();

        // Canon + presign (fallback base64)
        const canon = { type:isMAD?'mad':'course', whenISO, from, to, price_eur, mad_hours, pay_mode: payFull ? 'full' : 'deposit' };

        let signed;
        try{
          const r = await fetch('/.netlify/functions/sim-presign', {
            method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ canon })
          });
          if(!r.ok){
            const b64 = btoa(unescape(encodeURIComponent(JSON.stringify(canon))));
            signed = { signature:'', nonce:'', canon_b64:b64 };
          }else{
            signed = await r.json(); // { signature, canon_b64, nonce }
          }
        }catch(e){
          console.warn('presign error ‚Äî fallback', e);
          const b64 = btoa(unescape(encodeURIComponent(JSON.stringify(canon))));
          signed = { signature:'', nonce:'', canon_b64:b64 };
        }

        // Prefill Calendly (avec formats FR pour les champs texte)
        const cfg = isMAD ? CAL.mad : CAL.course;
        const ca  = {};
        if (cfg.qid.price && price_eur!=null) ca[cfg.qid.price] = (typeof TC!=='undefined' && TC.fmtMoney)? TC.fmtMoney(price_eur) : `${price_eur} ‚Ç¨`;
        if (cfg.qid.from  && from)            ca[cfg.qid.from]  = from;
        if (!isMAD && cfg.qid.to && to)       ca[cfg.qid.to]    = to;
        if (isMAD && cfg.qid.duration && mad_hours) ca[cfg.qid.duration] = `${mad_hours} h`;

        // >> Date/Heure dans les "custom answers"
        const rawDate = dateStr || (whenISO ? whenISO.slice(0,10) : '');
        const rawTime = timeStr || (whenISO ? whenISO.slice(11,16) : '');
        if (cfg.qid.date && rawDate) ca[cfg.qid.date] = toFRDate(rawDate);
        if (cfg.qid.time && rawTime) ca[cfg.qid.time] = toFRTime(rawTime);

        // >> Passagers & commentaires
        if (cfg.qid.pax  && paxStr)  ca[cfg.qid.pax]  = `${paxStr} passager${paxStr==='1'?'':'s'}`;
        if (cfg.qid.note && noteStr) ca[cfg.qid.note] = noteStr;

        // Pr√©selection de la date c√¥t√© Calendly (calendrier)
        const prefill = {
          date: dateStr || (whenISO ? whenISO.slice(0,10) : undefined),
          customAnswers: ca
        };

        // UTM (tra√ßabilit√©)
        const utm = {
          utm_source:  'simulator',
          utm_medium:  signed.signature || 'nosig',
          utm_term:    signed.nonce || '',
          utm_content: signed.canon_b64 || '',
          utm_campaign:(window._TC_LAST?.label || (isMAD?'MAD':'COURSE'))
        };

        // URL Calendly + th√®me
        const base = new URL(cfg.url);
        base.searchParams.set('background_color','0B0B0B');
        base.searchParams.set('text_color','FFFFFF');
        base.searchParams.set('primary_color','C7A24B');
        base.searchParams.set('utm_source', utm.utm_source);
        base.searchParams.set('utm_medium', utm.utm_medium);
        base.searchParams.set('utm_term', utm.utm_term);
        base.searchParams.set('utm_content', utm.utm_content);
        base.searchParams.set('utm_campaign', utm.utm_campaign);

        const host = document.getElementById('calendly-inline');
        if(!host){ alert('Zone calendrier manquante (#calendly-inline).'); return; }
        host.innerHTML='';

        /* ===== Patch "plein √©cran" Calendly ===== */
        const vh = Math.max(900, Math.round(window.innerHeight * 0.85));
        host.style.height = vh + 'px';
        const ensureFullHeight = () => {
          const w = host.querySelector('.calendly-inline-widget');
          const f = host.querySelector('.calendly-inline-widget iframe');
          if (w) { w.style.height = '100%'; w.style.minHeight = '100%'; }
          if (f) { f.style.height = '100%'; f.style.minHeight = '100%'; }
        };
        const mo = new MutationObserver(ensureFullHeight);
        mo.observe(host, { childList:true, subtree:true });
        let t;
        window.addEventListener('resize', () => {
          clearTimeout(t);
          t = setTimeout(() => {
            const nv = Math.max(900, Math.round(window.innerHeight * 0.85));
            host.style.height = nv + 'px';
            ensureFullHeight();
          }, 150);
        });
        /* ========================================= */

        Calendly.initInlineWidget({ url: base.toString(), parentElement: host, prefill, utm });
        host.scrollIntoView({ behavior:'smooth', block:'start' });
      }catch(e){
        console.error('openInlineCalendly failed:', e);
        alert('Impossible d‚Äôouvrir le calendrier.');
      }
    }

    // Hooks : bouton R√©server + auto-scroll carte (Estimer / #itineraire)
    document.addEventListener('DOMContentLoaded', ()=>{
      const btn = document.getElementById('calendly');
      if (btn) btn.addEventListener('click', (ev)=>{ ev.preventDefault(); openInlineCalendly(); });

      // Auto-scroll vers la carte si on arrive avec #itineraire
      const anchor = document.getElementById('itineraire');
      if (location.hash === '#itineraire' && anchor){
        setTimeout(()=> anchor.scrollIntoView({ behavior:'smooth', block:'start' }), 60);
      }

      // Quand on clique sur "Estimer", scroller vers la carte (laisser l‚Äôestimation s‚Äôex√©cuter)
      const est = document.getElementById('estimate');
      if (est && anchor){
        est.addEventListener('click', ()=>{
          setTimeout(()=> anchor.scrollIntoView({ behavior:'smooth', block:'start' }), 200);
        });
      }
    });
  </script>
</body>
</html>

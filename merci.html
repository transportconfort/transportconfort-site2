<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Paiement confirm√© ‚Ä¢ Transport Confort</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="robots" content="noindex">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/assets/style.css">
  <style>
    body { background:#0b0b0b; color:#fff; font-family:Inter,system-ui; }
    .container { max-width:960px; margin:32px auto; padding:0 16px; }
    .card { background:#151515; border-radius:12px; padding:20px; }
    .ok { color:#16c784; font-weight:700; }
    .muted { color:#aaa; }
    .grid { display:grid; gap:12px; grid-template-columns: 1fr 1fr; }
    @media (max-width:800px){ .grid{grid-template-columns:1fr;} }
    .btn { display:inline-block; padding:10px 14px; border-radius:10px; background:#c7a24b; color:#121212; font-weight:600; text-decoration:none; }
    .btn.secondary { background:#222; color:#fff; border:1px solid #333; }
    .row { margin:8px 0; }
    .label { display:inline-block; min-width:140px; color:#aaa; }
    .monospace { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    #note { margin-top:14px; padding:10px 12px; border-radius:10px; background:#201f1f; color:#ddd; display:none; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Merci pour votre paiement ‚úÖ</h1>
    <p class="muted">Votre r√©servation a bien √©t√© enregistr√©e. Vous recevez un e-mail de confirmation Stripe dans quelques instants.</p>

    <div id="box" class="card" role="status">
      Chargement des d√©tails du paiement‚Ä¶
    </div>

    <div class="row" style="margin-top:16px;">
      <a href="/" class="btn">Retour √† l‚Äôaccueil</a>
      <a href="/simulator.html" class="btn secondary" style="margin-left:8px;">Faire une autre r√©servation</a>
    </div>

    <!-- Bandeau d‚Äôinfo (masqu√© par d√©faut, s‚Äôaffiche seulement s‚Äôil y a une erreur) -->
    <div id="note"></div>

    <p class="muted" style="margin-top:18px;">
      Besoin d‚Äôaide ? Contactez-nous au <a href="tel:+33749556277" class="muted">07 49 55 62 77</a>.
    </p>
  </div>

  <script>
    function qs(name){ return new URLSearchParams(location.search).get(name) || ''; }
    function fmtEUR(cents){
      return (cents/100).toLocaleString('fr-FR', { style:'currency', currency:'EUR' });
    }
    function fmtDate(iso){
      try { return new Date(iso).toLocaleString('fr-FR'); } catch(e){ return iso || '‚Äî'; }
    }

    async function load(){
      const box  = document.getElementById('box');
      const note = document.getElementById('note');
      if (note) note.style.display = 'none';

      const sid = qs('session_id');
      if (!sid){
        box.innerHTML = `<p>Session de paiement introuvable.</p>
                         <p><a href="/simulator.html" class="btn secondary">Revenir au simulateur</a></p>`;
        return;
      }

      try {
        // üëâ un seul appel, endpoint sans .js, param√®tre 'id'
        const r = await fetch(`/.netlify/functions/stripe-session?id=${encodeURIComponent(sid)}`);
        if (!r.ok) throw new Error('HTTP '+r.status);
        const s = await r.json();  // { id, status, payment_status, amount_total, currency, metadata... }

        // Champs utiles (fallbacks prudents)
        const paidCents = s.amount_total ?? 0;
        const status    = s.payment_status || s.status || 'paid';
        const md        = s.metadata || {};
        const payMode   = md.pay_mode || 'deposit';
        const type      = md.type || '';
        const from      = md.from || '';
        const to        = md.to || '';
        const whenISO   = md.whenISO || '';
        const hours     = md.mad_hours || '';
        const baseEUR   = md.price_eur || '';
        const title     = (payMode === 'full' ? 'Paiement 100%' : 'Acompte 20%');

        const extraLine =
          (type === 'mad')
            ? `<div class="row"><span class="label">Prestation</span> Mise √† disposition ${hours || '?'} h</div>`
            : `<div class="row"><span class="label">Prestation</span> Course classique</div>`;

        box.innerHTML = `
          <p class="ok">${title} confirm√© ‚Äî ${fmtEUR(paidCents)}</p>
          <div class="grid">
            <div>
              ${extraLine}
              <div class="row"><span class="label">D√©part</span> ${from || '‚Äî'}</div>
              ${type==='mad' ? '' : `<div class="row"><span class="label">Arriv√©e</span> ${to || '‚Äî'}</div>`}
              <div class="row"><span class="label">Date/heure</span> ${fmtDate(whenISO)}</div>
            </div>
            <div>
              <div class="row"><span class="label">Statut Stripe</span> ${status}</div>
              <div class="row"><span class="label">Base estim√©e</span> ${baseEUR ? Number(baseEUR).toLocaleString('fr-FR',{style:'currency',currency:'EUR'}) : '‚Äî'}</div>
              <div class="row"><span class="label">Session</span> <span class="monospace">${s.id || ''}</span></div>
              <div class="row"><span class="label">Mode</span> ${payMode==='full' ? '100%' : 'Acompte 20%'}</div>
            </div>
          </div>
          <p class="muted" style="margin-top:10px;">Un e-mail de confirmation Stripe vous a √©t√© envoy√©. Vous recevrez un rappel avant la prestation.</p>
        `;

        // Nettoie l‚ÄôURL (on garde /merci.html sans les param√®tres)
        history.replaceState({}, '', location.pathname);

      } catch (e){
        console.error(e);
        // petit panneau d‚Äôalerte (au lieu d‚Äôune barre qui reste)
        if (note) {
          note.textContent = "Impossible de v√©rifier la session Stripe pour le moment.";
          note.style.display = 'block';
        }
        box.innerHTML = `<p>Impossible de r√©cup√©rer les d√©tails du paiement.</p>
                         <p><a href="/simulator.html" class="btn secondary">Revenir au simulateur</a></p>`;
      }
    }
    load();
  </script>
</body>
</html>

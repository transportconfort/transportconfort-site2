<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Paiement confirmé • Transport Confort</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="robots" content="noindex">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/assets/style.css">
  <style>
    body { background:#0b0b0b; color:#fff; font-family:Inter,system-ui; }
    .container { max-width:960px; margin:32px auto; padding:0 16px; }
    .card { background:#151515; border-radius:12px; padding:20px; }
    .ok { color:#16c784; font-weight:700; }
    .muted { color:#aaa; }
    .grid { display:grid; gap:12px; grid-template-columns: 1fr 1fr; }
    @media (max-width:800px){ .grid{grid-template-columns:1fr;} }
    .btn { display:inline-block; padding:10px 14px; border-radius:10px; background:#c7a24b; color:#121212; font-weight:600; text-decoration:none; }
    .btn.secondary { background:#222; color:#fff; border:1px solid #333; }
    .row { margin:8px 0; }
    .label { display:inline-block; min-width:140px; color:#aaa; }
    .monospace { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Merci pour votre paiement ✅</h1>
    <p class="muted">Votre réservation a bien été enregistrée. Vous recevez un e-mail de confirmation Stripe dans quelques instants.</p>

    <div id="box" class="card" role="status">
      Chargement des détails du paiement…
    </div>

    <div class="row" style="margin-top:16px;">
      <a href="/" class="btn">Retour à l’accueil</a>
      <a href="/simulator.html" class="btn secondary" style="margin-left:8px;">Faire une autre réservation</a>
    </div>

    <p class="muted" style="margin-top:18px;">
      Besoin d’aide ? Contactez-nous au <a href="tel:+33749556277" class="muted">07 49 55 62 77</a>.
    </p>
  </div>

  <script>
    function qs(name){ return new URLSearchParams(location.search).get(name) || ''; }
    function fmtEUR(cents){
      return (cents/100).toLocaleString('fr-FR', { style:'currency', currency:'EUR' });
    }
    function fmtDate(iso){
      try { return new Date(iso).toLocaleString('fr-FR'); } catch(e){ return iso || '—'; }
    }

    async function load(){
      const box = document.getElementById('box');
      const sid = qs('session_id');

      if (!sid){
        box.innerHTML = `<p>Session de paiement introuvable.</p>
                         <p><a href="/simulator.html" class="btn secondary">Revenir au simulateur</a></p>`;
        return;
      }

      try {
        // Netlify function déjà dans ton repo: /netlify/functions/stripe-session.js
        const r = await fetch(`/.netlify/functions/stripe-session?session_id=${encodeURIComponent(sid)}`);
        if (!r.ok) throw new Error('HTTP '+r.status);
        const s = await r.json();  // contient fields Stripe + s.metadata

        // Champs utiles
        const paid     = s.amount_total ?? 0;
        const status   = s.payment_status || s.status || 'paid';
        const payMode  = (s.metadata && s.metadata.pay_mode) || 'deposit';
        const type     = (s.metadata && s.metadata.type) || '';
        const from     = (s.metadata && s.metadata.from) || '';
        const to       = (s.metadata && s.metadata.to) || '';
        const whenISO  = (s.metadata && s.metadata.whenISO) || '';
        const hours    = (s.metadata && s.metadata.mad_hours) || '';
        const baseEUR  = (s.metadata && s.metadata.price_eur) || '';
        const title    = (payMode==='full' ? 'Paiement 100%' : 'Acompte 20%');

        const extraLine =
          (type === 'mad')
            ? `<div class="row"><span class="label">Prestation</span> Mise à disposition ${hours || '?'} h</div>`
            : `<div class="row"><span class="label">Prestation</span> Course classique</div>`;

        box.innerHTML = `
          <p class="ok">${title} confirmé — ${fmtEUR(paid)}</p>
          <div class="grid">
            <div>
              ${extraLine}
              <div class="row"><span class="label">Départ</span> ${from || '—'}</div>
              ${type==='mad' ? '' : `<div class="row"><span class="label">Arrivée</span> ${to || '—'}</div>`}
              <div class="row"><span class="label">Date/heure</span> ${fmtDate(whenISO)}</div>
            </div>
            <div>
              <div class="row"><span class="label">Statut Stripe</span> ${status}</div>
              <div class="row"><span class="label">Base estimée</span> ${baseEUR ? Number(baseEUR).toLocaleString('fr-FR', {style:'currency',currency:'EUR'}) : '—'}</div>
              <div class="row"><span class="label">Session</span> <span class="monospace">${s.id || ''}</span></div>
              <div class="row"><span class="label">Mode</span> ${payMode==='full' ? '100%' : 'Acompte 20%'}</div>
            </div>
          </div>
          <p class="muted" style="margin-top:10px;">Un e-mail de confirmation Stripe vous a été envoyé. Vous recevrez un rappel avant la prestation.</p>
        `;
      } catch (e){
        console.error(e);
        box.innerHTML = `<p>Impossible de récupérer les détails du paiement.</p>
                         <p><a href="/simulator.html" class="btn secondary">Revenir au simulateur</a></p>`;
      }
    }
    load();
  </script>
</body>
</html>

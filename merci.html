<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Paiement confirm√© ‚Ä¢ Transport Confort</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="robots" content="noindex">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/assets/style.css">
  <style>
    :root{--bg:#0b0b0b;--fg:#ffffff;--muted:#bdbdbd;--gold:#c7a24b;--line:#1f1f1f;--card:#141414;}
    body{background:var(--bg);color:var(--fg);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .container{max-width:980px;margin:32px auto;padding:0 16px}
    .card{background:linear-gradient(180deg,#151515,#101010);border:1px solid var(--line);border-radius:14px;padding:20px;box-shadow:0 10px 24px rgba(0,0,0,.25)}
    .ok{color:#16c784;font-weight:700}
    .muted{color:var(--muted)}
    .grid{display:grid;gap:12px;grid-template-columns:1fr 1fr}
    @media (max-width:820px){.grid{grid-template-columns:1fr}}
    .btn{display:inline-block;padding:11px 16px;border-radius:12px;background:var(--gold);color:#151515;font-weight:700;text-decoration:none;box-shadow:0 8px 18px rgba(0,0,0,.25)}
    .btn.secondary{background:#222;color:#fff;border:1px solid var(--line)}
    .row{margin:8px 0}
    .label{display:inline-block;min-width:150px;color:var(--muted)}
    .monospace{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    #note{margin-top:14px;padding:10px 12px;border-radius:10px;background:#201f1f;color:#ddd;display:none}
    h1{display:flex;align-items:center;gap:10px}
    h1 .tick{display:inline-flex;align-items:center;justify-content:center;width:26px;height:26px;border-radius:6px;background:rgba(22,199,132,.12);border:1px solid rgba(22,199,132,.35)}
    h1 .tick::before{content:"‚úì";color:#16c784;font-weight:900}
  </style>
</head>
<body>
  <div class="container">
    <h1>Merci pour votre paiement <span class="tick" aria-hidden="true"></span></h1>
    <p class="muted">Votre r√©servation a bien √©t√© enregistr√©e. Un e-mail de confirmation Stripe arrive dans quelques instants.</p>

    <div id="box" class="card" role="status">
      Chargement des d√©tails du paiement‚Ä¶
    </div>

    <div class="row" style="margin-top:16px">
      <a href="/" class="btn">Retour √† l‚Äôaccueil</a>
      <a href="/simulator.html" class="btn secondary" style="margin-left:8px">Faire une autre r√©servation</a>
    </div>

    <div id="note"></div>

    <p class="muted" style="margin-top:18px">
      Besoin d‚Äôaide ? Contactez-nous au <a class="muted" href="tel:+33749556277">07&nbsp;49&nbsp;55&nbsp;62&nbsp;77</a>.
    </p>
  </div>

  <script>
    // ----- Helpers
    const qs = n => new URLSearchParams(location.search).get(n) || "";
    const fmtEUR = cents => (Number(cents||0)/100).toLocaleString("fr-FR",{style:"currency",currency:"EUR"});
    const fmtDate = iso => { try{ return new Date(iso).toLocaleString("fr-FR"); }catch{ return iso||"‚Äî"; } };

    async function load(){
      const box  = document.getElementById("box");
      const note = document.getElementById("note"); note.style.display="none";

      // Stripe redirige vers /merci.html?session_id=cs_...
      const sid = qs("session_id") || qs("id");
      if(!sid){
        box.innerHTML = `
          <p>Session de paiement introuvable.</p>
          <p><a href="/simulator.html" class="btn secondary">Revenir au simulateur</a></p>`;
        return;
      }

      try{
        // üëâ endpoint Netlify unifi√©
        const r = await fetch(`/.netlify/functions/stripe-get-session?session_id=${encodeURIComponent(sid)}`, { cache:"no-store" });
        if(!r.ok) throw new Error("HTTP "+r.status);
        const s = await r.json();

        // Champs utiles
        const paidCents = s.amount_total ?? 0;
        const status    = s.payment_status || s.status || "paid";
        const md        = s.metadata || {};
        const payMode   = md.pay_mode || "deposit";       // "full" | "deposit"
        const type      = md.type || "";                   // "mad" | "course"
        const from      = md.from || "";
        const to        = md.to || "";
        const whenISO   = md.whenISO || "";
        const hours     = md.mad_hours || "";
        const baseEUR   = md.price_eur ? Number(md.price_eur) : null;

        // E-mail client (diff√®re selon versions/param√®tres Stripe)
        const email = (s.customer_details && s.customer_details.email)
                   || s.customer_email
                   || (s.customer && s.customer.email)
                   || "";

        const title = (payMode === "full" ? "Paiement 100%" : "Acompte 20%");

        const extraLine = (type === "mad")
          ? `<div class="row"><span class="label">Prestation</span> Mise √† disposition ${hours||"?"} h</div>`
          : `<div class="row"><span class="label">Prestation</span> Course classique</div>`;

        box.innerHTML = `
          <p class="ok">${title} confirm√© ‚Äî ${fmtEUR(paidCents)}</p>
          <div class="grid">
            <div>
              ${extraLine}
              <div class="row"><span class="label">D√©part</span> ${from || "‚Äî"}</div>
              ${type==="mad" ? "" : `<div class="row"><span class="label">Arriv√©e</span> ${to || "‚Äî"}</div>`}
              <div class="row"><span class="label">Date/heure</span> ${fmtDate(whenISO)}</div>
            </div>
            <div>
              <div class="row"><span class="label">Statut Stripe</span> ${status}</div>
              <div class="row"><span class="label">E-mail</span> ${email || "‚Äî"}</div>
              <div class="row"><span class="label">Base estim√©e</span> ${baseEUR!=null ? baseEUR.toLocaleString("fr-FR",{style:"currency",currency:"EUR"}) : "‚Äî"}</div>
              <div class="row"><span class="label">Session</span> <span class="monospace">${s.id || ""}</span></div>
              <div class="row"><span class="label">Mode</span> ${payMode==="full" ? "100%" : "Acompte 20%"}</div>
            </div>
          </div>
          <p class="muted" style="margin-top:10px">
            Un e-mail de confirmation Stripe vous a √©t√© envoy√©. Vous recevrez un rappel avant la prestation.
          </p>
        `;

        // Nettoie l‚ÄôURL (on garde /merci.html)
        history.replaceState({}, "", location.pathname);

      }catch(err){
        console.error(err);
        note.textContent = "Impossible de v√©rifier la session Stripe pour le moment.";
        note.style.display = "block";
        box.innerHTML = `
          <p>Impossible de r√©cup√©rer les d√©tails du paiement.</p>
          <p><a href="/simulator.html" class="btn secondary">Revenir au simulateur</a></p>`;
      }
    }
    load();
  </script>
</body>
</html>
